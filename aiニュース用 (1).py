# -*- coding: utf-8 -*-
"""AIãƒ‹ãƒ¥ãƒ¼ã‚¹ç”¨

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1B8Yqpyos50nhN8YxKg2pmQ7A-BBepk7V
"""

import feedparser
import openai
from slack_sdk.webhook import WebhookClient
import os

# --- APIã‚­ãƒ¼ã¯GitHub Secretsã‹ã‚‰å–å¾— ---
openai.api_key = os.getenv("OPENAI_API_KEY")
slack_webhook_url = os.getenv("SLACK_WEBHOOK_URL")

# --- ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ï¼ˆRSSã‹ã‚‰å–å¾—ï¼‰ ---
def fetch_rss(feed_url, max_items=2):
    feed = feedparser.parse(feed_url)
    articles = []
    for entry in feed.entries[:max_items]:
        articles.append({
            "title": entry.title,
            "link": entry.link,
            "summary": entry.get("summary", "") or entry.get("description", "")
        })
    return articles

# --- GPTã«ã‚ˆã‚‹è¦ç´„ï¼ˆRSSè¨˜äº‹ç”¨ï¼‰ ---
def summarize_article(article_text):
    prompt = f"""
ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã€ŒIndeedã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¯ã‚»ã‚¹æ‹…å½“è€…ãŒç¤¾å†…å…±æœ‰ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µãƒãƒªãƒ¼ã€ã¨ã—ã¦è¦ç´„ã—ã¦ãã ã•ã„ã€‚

å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯å¿…ãšæ—¥æœ¬èªã§ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼š
ğŸ“° ã‚¿ã‚¤ãƒˆãƒ«
âœ… ä¸–ã®ä¸­ã¯ã©ã†å¤‰ã‚ã‚‹ã‹ï¼Ÿ
ğŸ‘‰ æ¡ç”¨ãƒ»äººææ¥­ç•Œã¸ã®å½±éŸ¿ã¯ï¼Ÿ
ğŸŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä¼ãˆã‚‹ã¹ãã“ã¨ï¼ˆå…·ä½“çš„ãªä¾‹ï¼‰
ğŸ’¡ Indeedã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¯ã‚»ã‚¹ï¼ˆCSï¼‰ã¨ã—ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ğŸ”‘ ãã‚Œã§ã‚‚Indeedã«æœŸå¾…ã•ã‚Œã‚‹å½¹å‰²ï¼ˆæ±‚äººã®ä¿¡é ¼æ€§ãƒ»AIæ™‚ä»£ã®ã‚µãƒãƒ¼ãƒˆãªã©ï¼‰
"""

    response = openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt + article_text}],
        temperature=0.5,
    )
    return response.choices[0].message.content



# --- GPTãƒ‹ãƒ¥ãƒ¼ã‚¹è£œè¶³ï¼ˆæ¤œç´¢ãƒ™ãƒ¼ã‚¹ï¼‰ ---
def fetch_gpt_news():
    prompt = """
    ä»Šæ—¥ã®AIé–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’3ä»¶ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
    ãã‚Œãã‚Œã«ã¤ã„ã¦ï¼š
    - ã‚¿ã‚¤ãƒˆãƒ«
    - è¦ç‚¹ã®ã¾ã¨ã‚ï¼ˆ100æ–‡å­—ä»¥å†…ï¼‰
    - å‡ºå…¸URLï¼ˆä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‚’1ã¤æ¢ã—ã¦æç¤ºï¼‰
    ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
    æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    """
    res = openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.5,
    )
    return res.choices[0].message.content

# --- SlackæŠ•ç¨¿ ---
def post_to_slack(title, summary, link):
    webhook = WebhookClient(slack_webhook_url)
    message = f"""
*ğŸ“° {title}*
{summary}

ğŸ”— <{link}|è¨˜äº‹ã¯ã“ã¡ã‚‰>
"""
    webhook.send(text=message)


# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
if __name__ == "__main__":
    rss_urls = [
        # ğŸŒ æµ·å¤–
        "https://techcrunch.com/tag/artificial-intelligence/feed/",
        "https://venturebeat.com/category/ai/feed/",
        "https://www.technologyreview.com/feed/",
        "https://www.theverge.com/artificial-intelligence/rss/index.xml",
        "http://feeds.bbci.co.uk/news/technology/rss.xml",

        # ğŸ‡¯ğŸ‡µ å›½å†…
        "https://www.nikkei.com/rss/technology.rdf",
        "https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml",
        "https://www.hrpro.co.jp/rss/"
    ]

    # --- RSSãƒ‹ãƒ¥ãƒ¼ã‚¹é…ä¿¡ ---
    for url in rss_urls:
        articles = fetch_rss(url, max_items=2)
        for article in articles:
            print(f"å‡¦ç†ä¸­: {article['title']}")
            summary = summarize_article(article["summary"] or article["title"])
            post_to_slack(article["title"], summary, article["link"])
            print("Slackã«é€ä¿¡ã—ã¾ã—ãŸ âœ…")

    # --- GPTãƒ‹ãƒ¥ãƒ¼ã‚¹è£œè¶³ ---
    print("GPTãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾—ä¸­...")
    gpt_news = fetch_gpt_news()
    post_to_slack("ğŸ§  GPTãƒ‹ãƒ¥ãƒ¼ã‚¹è£œè¶³", gpt_news, "https://chat.openai.com/")
    print("GPTãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’Slackã«é€ä¿¡ã—ã¾ã—ãŸ âœ…")