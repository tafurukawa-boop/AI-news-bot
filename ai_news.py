# -*- coding: utf-8 -*-
"""AIãƒ‹ãƒ¥ãƒ¼ã‚¹

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1B8Yqpyos50nhN8YxKg2pmQ7A-BBepk7V
"""

import feedparser
import openai
from slack_sdk.webhook import WebhookClient
import os

# --- APIã‚­ãƒ¼ã¯GitHub Secretsã‹ã‚‰å–å¾— ---
openai.api_key = os.getenv("OPENAI_API_KEY")
slack_webhook_url = os.getenv("SLACK_WEBHOOK_URL")

# --- ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†ï¼ˆRSSã‹ã‚‰å–å¾—ï¼‰ ---
def fetch_rss(feed_url, max_items=2):
    feed = feedparser.parse(feed_url)
    articles = []
    for entry in feed.entries[:max_items]:
        articles.append({
            "title": entry.title,
            "link": entry.link,
            "summary": entry.get("summary", "")
        })
    return articles

# --- GPTã«ã‚ˆã‚‹è¦ç´„ ---
def summarize_article(article_text):
    prompt = f"""
    ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã€Œäººææ¥­ç•ŒÃ—AIãƒ‹ãƒ¥ãƒ¼ã‚¹å…±æœ‰ä¼šã€ç”¨ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚
    âœ… ä¸–ã®ä¸­ã¯ã©ã†å¤‰ã‚ã‚‹ã‹ï¼Ÿ
    ğŸ‘‰ é‡è¦ãƒã‚¤ãƒ³ãƒˆï¼ˆç®‡æ¡æ›¸ãï¼‰
    ğŸŸ¢ å…·ä½“ä¾‹
    ã²ã¨ã“ã¨ï¼ˆç¤ºå”†ï¼‰
    """
    response = openai.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt + article_text}],
        temperature=0.5,
    )
    return response.choices[0].message.content

# --- SlackæŠ•ç¨¿ ---
def post_to_slack(title, summary, link):
    webhook = WebhookClient(slack_webhook_url)
    message = f"*{title}*\n{summary}\n<{link}|è¨˜äº‹ã¯ã“ã¡ã‚‰>"
    webhook.send(text=message)

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
if __name__ == "__main__":
    rss_urls = [
        "http://feeds.bbci.co.uk/news/technology/rss.xml",  # ä¸–ç•ŒAIãƒ‹ãƒ¥ãƒ¼ã‚¹
        "https://www.hrpro.co.jp/rss/"                      # äººæÃ—AIãƒ‹ãƒ¥ãƒ¼ã‚¹
    ]
    for url in rss_urls:
        articles = fetch_rss(url, max_items=2)
        for article in articles:
            print(f"å‡¦ç†ä¸­: {article['title']}")
            summary = summarize_article(article["summary"])
            post_to_slack(article["title"], summary, article["link"])
            print("Slackã«é€ä¿¡ã—ã¾ã—ãŸ âœ…")
